// React
import React, { useContext, useRef } from 'react';
// Antd
import { DeleteOutlined, EditOutlined } from '@ant-design/icons';
import { ActionType, PageContainer, ProProvider, TableDropdown } from '@ant-design/pro-components';
import { Button, Layout, message, Segmented, Space, Typography } from 'antd';
// Umi
import { Access } from '@umijs/max';
import { history } from 'umi';
// Components
import { CreateModal } from '@/components/CreateModal';
import { valueTypeMap } from '@/components/schema-components';
import { UltraColumns } from '@/components/UltraColumns';
import UltraTable from '@/components/UltraTable';
// Services
import { create<%= PascalCase %>, delete<%= PascalCase %>, query<%= PascalCase %>List } from '@/services/cmp/<%= camelCase %>';
// Hooks
import { useDetailPageDrawer } from '@/hooks/detailPageDrawer';
import { useListState } from '@/hooks/listState';
import { usePageConfig } from '@/hooks/pageConfig';
import { usePageParam } from '@/hooks/pageParam';
// Definitions
import { gen<%= PascalCase %>Columns } from './<%= camelCase %>.column';
import { gen<%= PascalCase %>FormColumns } from './<%= camelCase %>.form';


const { Content } = Layout;

// Types
type T<%= PascalCase %>Filter = API.Filter<<%= PascalCase %>>;

const <%= PascalCase %>List: React.FC = () => {
  // 引用上下文
  const contextFormValues = useContext(ProProvider);
  // useRef
  const actionRef = useRef<ActionType>();
  // 页面参数
  const { valueEnums, cusParams } = usePageParam();
  // 页面配置
  const { routeKey, access, privileges, presetColumns, presetFilters, viewFilterEnum } = usePageConfig();
  // 列表状态
  const { view, setView, currentRow, setCurrentRow, setCurrentFilter, confirmDelete } = useListState<<%= PascalCase %>>(
    actionRef,
    {
      viewFilterEnum,
      onDelete: (records: ManifestHead[]) => delete<%= PascalCase %>(records.map((record) => record.uid)),
    },
  );

 
  // 详情页 Drawer
  const { detailPageDrawerOpen, setDetailPageDrawerOpen, DetailPageDrawer } = useDetailPageDrawer(
    <<%= PascalCase %>Detail uid={currentRow?.uid!} onUpdated={() => {}} insideDrawer />,
  );

  // Actions
  const gotoDetailPage = (uid: string) => {
    history.push(`/filing/<%= camelCase %>/${uid}`);
  };

  // Table Columns
  const actionRender = (dom: React.ReactNode, record: <%= PascalCase %>) => [
  <Access key="read" accessible={access.canRead(privileges)}>
    <Button
      key="read"
      type="link"
      size="small"
      onClick={() => gotoDetailPage(record.uid)}
      // onClick={() => {
      //   setCurrentRow(record);
      //   setDetailPageDrawerOpen(true);
      // }}
    >
      <EditOutlined />
    </Button>
  </Access>,
  <Access key="dropdown" accessible={access.canDestroy(privileges)}>
    <TableDropdown
      key="dropdown"
      menus={[{ key: 'delete', name: <Typography.Text type="danger">删除</Typography.Text> }]}
      onSelect={(key: string) => {
        if (key === 'delete') {
          confirmDelete([record]);
        }
      }}
    />
  </Access>,
  ];

  const ultraColumns = new UltraColumns<<%= PascalCase %>>(
    gen<%= PascalCase %>Columns({
      presetColumns,
      valueEnums,
      cusParams,
    }),
    actionRender,
  );

  return (
    <PageContainer
      ghost
      header={{
        title: '<%= label %>',
        
      }}
    >
      <Layout className="ant-layout-has-sider">
        <Content style={{ background: '#fff' }}>
          <ProProvider.Provider
          value={{
            ...contextFormValues,
            valueTypeMap,
          }}
        >
          <UltraTable
            rowKey="uid"
            headerTitle={
              <Space>
                <Segmented
                options={presetFilters}
                value={view}
                onChange={(value) => {
                  setView(value as string);
                  actionRef.current?.reloadAndRest?.();
                }}
                style={{ marginLeft: 4 }}
              />
              </Space>
            }
            actionRef={actionRef}
            columns={ultraColumns.getColumns()}
            search={{
              labelWidth: 'auto',
            }}
            request={async (params, sorter) => {
              const { current, pageSize, ...search } = params;
              const filter: T<%= PascalCase %>Filter = { ...ultraColumns.generateFilter(search), ...viewFilterEnum[view]};
              setCurrentFilter(filter);
              const res = await query<%= PascalCase %>List({
                current,
                pageSize,
                columns: ultraColumns.getColumnKeys(),
                filter,
                sorter: Object.keys(sorter).length > 0 ? sorter : undefined,
                // tenantId,
              });
              // setIdentifiers(res.result.data.map((item) => item.uid!));
              return {
                data: res.result.data,
                success: res.success,
                total: res.result.total,
              };
            }}
            toolBarRender={() => [
              <Access key="create" accessible={access.canCreate(privileges)}>
              <CreateModal
                key="create"
                title="新建<%= label %>"
                layoutType="DrawerForm"
                formLayout="horizontal"
                formColumns={gen<%= PascalCase %>FormColumns({
                  isCreate: true,
                })}
                onCreate={async (values: <%= PascalCase %>) => {
                  const res = await create<%= PascalCase %>(values);
                  if (res.success) {
                    message.success('新建成功');
                    actionRef.current?.reload();
                  }
                  return res.success;
                }}
              />
            </Access>,
            ]}
            rowSelection={{}}
            tableAlertRender={({ selectedRowKeys, selectedRows, onCleanSelected }) => (
              <Space size={24}>
                <span>已选 {selectedRowKeys.length} 项</span>
                <Access accessible={access.canTenantAdmin(privileges)}>
                <Button
                  key="delete"
                  type="link"
                  icon={<DeleteOutlined />}
                  onClick={() => {
                    confirmDelete(selectedRows);
                  }}
                >
                  删除
                </Button>
              </Access>
              </Space>
            )}
            locale={
              {
                // emptyText: () => renderEmptyText(actionRef, declarationStatistic?.unclassified, setAspect),
              }
            }
            columnsState={{
              persistenceKey: routeKey,
              persistenceType: 'localStorage',
            }}
            scroll={{ x: ultraColumns.totalWidth }}
            // scrollYOffset={344}
          />
        </ProProvider.Provider>
          <DetailPageDrawer
            values={currentRow}
            drawerOpen={detailPageDrawerOpen}
            onCancel={() => {
              actionRef.current?.reload();
              setDetailPageDrawerOpen(false);
              setCurrentRow(undefined);
            }}
          />
        </Content>
      </Layout>
    </PageContainer>
  );
};
export default <%= PascalCase %>List;
