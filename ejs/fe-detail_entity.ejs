// React
import React, { useContext, useMemo, useRef, useState } from 'react';
// Antd
import { SaveOutlined } from '@ant-design/icons';
import { PageContainer, ProCard, ProFormInstance, ProProvider, TableDropdown } from '@ant-design/pro-components';
import { message } from 'antd';
// Umi
// Components
import { valueTypeMap, ValueTypeMapKey } from '@/components/schema-components';
import BetaSchemaForm from '@/components/SchemaForm';
import AuditLog from '@/pages/components/AuditLog';
// Services
import { get<%= PascalCase %>, update<%= PascalCase %> } from '@/services/cmp/<%= camelCase %>';
// Utils
import { ActionMap, getUpdateData, renderActions } from '@/utils';
// Hooks
import { useDevInspector } from '@/hooks/devInspector';
import { useFormState } from '@/hooks/formState';
import { usePageConfig } from '@/hooks/pageConfig';
import { usePageParam } from '@/hooks/pageParam';
import { useStateMachine } from '@/hooks/stateMachine';
// Definitions
import { gen<%= PascalCase %>FormColumns } from './<%= camelCase %>.form';
// Subpages


type <%= PascalCase %>DetailProps = {
  uid: string;
  onUpdated?: () => void;
  onClose?: () => void;
  insideDrawer?: boolean;
};

export const ParentContext = React.createContext<{
  contextRouteKey?: string;
  contextValues?: <%= PascalCase %>;
  contextState?: StateType;
}>({});

const <%= PascalCase %>Detail: React.FC<<%= PascalCase %>DetailProps> = (props) => {
  // 引用上下文
  const contextFormValues = useContext(ProProvider);
  // 页面参数
  const { uid } = usePageParam(props);
  // 页面配置
  const { routeKey, access, privileges } = usePageConfig();

  // useRef
  const formRef = useRef<ProFormInstance<<%= PascalCase %>>>();
  // 表单状态
  const {
    loading,
    setLoading,
    formLayout,
    FormLayoutSegmented,
    currentValues,
    setCurrentValues,
    valuesChanged,
    setValuesChanged,
    updateCurrentValues,
    Reload,
    ResolveConflictModal,
  } = useFormState<<%= PascalCase %>>(formRef, get<%= PascalCase %>, update<%= PascalCase %>);
  // 状态机
  const { currentState } = useStateMachine('<%= PascalCase %>', currentValues?.stateCode!);

  const [tabActiveKey, setTabActiveKey] = useState('main');

    const actions: ActionMap = useMemo(() => {
    return {
      save: {
        text: '保存',
        icon: <SaveOutlined />,
        type: 'primary',
        disabled: !valuesChanged,
        onClick: () => formRef.current?.submit(),
        accessible: access.canWrite(privileges),
      },
    };
  }, [valuesChanged, access, privileges, formRef.current]);

  const { DevInspector } = useDevInspector({ routeKey, currentValues, currentState, access, privileges });

  return (
      <PageContainer
        ghost
        header={{
          title: currentValues?.uid,
          onBack: props.insideDrawer ? undefined : () => history.back(),
          breadcrumb: {
            routes: [
              {
                path: '/',
                breadcrumbName: '<%= label %>',
              },
            ],
          },
          style: { zIndex: 10 },
        }}
        fixedHeader
        tabList={[
          {
            tab: '主信息',
            key: 'main',
          },
          {
            tab: '明细项',
            key: 'items',
          },
          {
            tab: '操作记录',
            key: 'auditLog',
          },
        ]}
        tabActiveKey={tabActiveKey}
        onTabChange={(key: string) => setTabActiveKey(key)}
        extra={[
          ...renderActions(actions, currentState!),
          <Reload key="reload" />,
          <DevInspector key="dev" />,
          <ResolveConflictModal key="resolveConflict" />,
          <TableDropdown key="dropdown" menus={[FormLayoutSegmented]} onSelect={(key: string) => {}} />,
        ]}
        style={{ marginBottom: 45 }}
      >
      <ParentContext.Provider value={{ contextRouteKey: routeKey, contextValues: currentValues, contextState: currentState }}>
        {tabActiveKey === 'main' && (
          <ProProvider.Provider
          value={{
            ...contextFormValues,
            valueTypeMap,
          }}
        >
          <ProCard bordered>
            <BetaSchemaForm<<%= PascalCase %>, ValueTypeMapKey>
              loading={loading}
              layout={formLayout}
              layoutType="Form"
              rowProps={{
                gutter: [16, 16],
              }}
              grid
              columns={gen<%= PascalCase %>FormColumns(
                {
                  uid: currentValues?.uid!,
                  updateFn: () => formRef.current?.submit(),
                },
                access,
              )}
              formRef={formRef}
              request={async () => {
                const res = await get<%= PascalCase %>(uid!);
                setCurrentValues(res.result!);
                setLoading(false);
                return res.result!;
              }}
              //** 允许字段更新为null */
              omitNil={false}
              onFinish={async (values: any) => {
                updateCurrentValues(values);
              }}
                onValuesChange={async (changedValues: any) => {
                  setValuesChanged(true);
                }}
              submitter={false}
            />
          </ProCard>
        </ProProvider.Provider>
        )}
        {tabActiveKey === 'auditLog' && (
          <ProCard bordered>
            <AuditLog sourceUid={uid!} />
          </ProCard>
        )}
      </ParentContext.Provider>
      </PageContainer>
  );
};
export default <%= PascalCase %>Detail;
